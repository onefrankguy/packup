<?xml version="1.0" encoding="UTF-8"?>
<Wix xmlns="http://schemas.microsoft.com/wix/2006/wi">
  <Product
    Id="*"
    Language="1033"
    Name="<%= name %>"
    Version="<%= version %>"
    Manufacturer="<%= author %>"
    UpgradeCode="<%=
      require 'digest/md5'
      hex = Digest::MD5.hexdigest(name).upcase.scan(/.{4}/)
      hex[0,2] = hex[0,2].join('')
      hex[-3,3] = hex[-3,3].join('')
      hex.join('-')
    %>"
  >

   <Package Compressed="yes" />
   <MediaTemplate EmbedCab="yes" />

   <FeatureRef Id="<%= name %>Feature" />
  </Product>

  <Fragment>
    <Directory Id="TARGETDIR" Name="SourceDir">
     <Directory Id="ProgramFilesFolder">
       <Directory Id="ManufacturerFolder" Name="<%= author %>">
         <Directory Id="INSTALLDIR" Name="<%= name %>" />
       </Directory>
     </Directory>
   </Directory>
  </Fragment>

  <Fragment>
    <DirectoryRef Id="INSTALLDIR">
    <% files.each do |unused, path| %>
      <% id = File.dirname(path) %>
      <% if id != '.' %>
      <Directory Id="<%= id %>" Name="<%= id %>" />
      <% end %>
    <% end %>
    </DirectoryRef>
  </Fragment>

  <Fragment>
    <Feature Id="<%= name %>Feature" Level="1">
    <% files.each do |unused, path| %>
      <ComponentRef Id="<%= File.basename(path) %>" />
    <% end %>
    </Feature>
  </Fragment>

  <Fragment>
    <% files.each do |source, dest| %>
      <% dir = File.dirname(dest) %>
      <% dir = 'INSTALLDIR' if dir == '.' %>
      <DirectoryRef Id="<%= dir %>">
        <Component Id="<%= File.basename(source) %>">
          <File Id="<%= File.basename(source) %>" Source="<%= source %>" />
        </Component>
      </DirectoryRef>
    <% end %>
  </Fragment>
</Wix>
